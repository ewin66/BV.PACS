@using BV.PACS.WEB.Shared.Models
@inherits BV.PACS.WEB.Client.Materials.BatchContentGridPanelCode

@if (DataSource != null && DataSource.Count > 0)
{
    <DxFormLayout CaptionPosition="@CaptionPosition.Vertical">
        <DxFormLayoutItem ColSpanLg="12" ColSpanMd="12">
            <Template Context="GridContext">
                <DxDataGrid @ref="@grid" 
                                 Data="@DataSource"
                                 ShowFilterRow="@false"
                                 ShowPager="@false"
                                 AllowDataRowSelection="@true"
                                 PageSize="@BaseSettings.MaxBatchRegistrationSize"
                                 RowRemoving=@((dataItem) => OnRowRemoving(dataItem))
                                 RowEditStart=@(dataItem => OnRowEditStarting(dataItem))
                                 RowInsertStart=@(() => OnRowEditStarting(null))>

                    <ChildContent>
                        <DxDataGridCommandColumn Width="150px"></DxDataGridCommandColumn>
                        <DxDataGridColumn Field="@nameof(BatchRegistrationDto.SourceBarcode)" Caption="@Translations.SourceBarcode">

                        </DxDataGridColumn>

                        <DxDataGridColumn Field="@nameof(BatchRegistrationDto.SourceTemplateName)" Caption="@Translations.SourceTemplate">
                            @*<EditTemplate>
                                @{
                                    var editingContext = (CellEditContext) context;
                                    var templateId = (string) editingContext.GetEditorValue(nameof(BatchRegistrationDto.SourceTemplateId));
                                    var template = SourceTemplates.FirstOrDefault(t => t.Id == templateId);
                                }

                                <DxComboBox Data="@SourceTemplates"
                                            NullText="@PacsMessagesTranslations.SelectTemplate"
                                            SelectedItem=@template
                                            SelectedItemChanged=@(newCellValue => editingContext.OnChanged(newCellValue))>
                                </DxComboBox>


                            </EditTemplate>*@ 
                        </DxDataGridColumn>


                        <DxDataGridColumn Field="@nameof(BatchRegistrationDto.SourceTypeId)" Caption="@Translations.SourceType">
                        </DxDataGridColumn>

                        <DxDataGridDateEditColumn Field="@nameof(BatchRegistrationDto.MaterialBarcode)" Caption="@Translations.MaterialBarcode">
                        </DxDataGridDateEditColumn>

                        <DxDataGridColumn Field="@nameof(BatchRegistrationDto.MaterialTemplateName)" Caption="@Translations.MaterialTemplate">
                        </DxDataGridColumn>

                        <DxDataGridColumn Field="@nameof(BatchRegistrationDto.MaterialTypeId)" Caption="@Translations.MaterialType">
                        </DxDataGridColumn>

                        <DxDataGridColumn Field="@nameof(BatchRegistrationDto.AliquotBarcode)" Caption="@Translations.AliquotBarcode">
                        </DxDataGridColumn>

                        <DxDataGridColumn Field="@nameof(BatchRegistrationDto.AliquotTemplateName)" Caption="@Translations.AliquotTemplate">
                        </DxDataGridColumn>

                        <DxDataGridColumn Field="@nameof(BatchRegistrationDto.AliquotLocation)" Caption="@Translations.AliquotLocation">
                        </DxDataGridColumn>
                    </ChildContent>

                    <EditFormTemplate>
                        <EditForm Model="@EditContext" Context="EditFormContext" OnValidSubmit=@HandleValidSubmit>
                            <DataAnnotationsValidator/>
                            <DxFormLayout>
                                <DxFormLayoutItem Caption="@Translations.SourceTemplate" ColSpanMd="12" Context="FormLayoutContext">
                                    <Template>

                                        @{
//                                            var editingContext = (CellEditContext) FormLayoutContext;
//                                            var templateId = (string) editingContext.GetEditorValue(nameof(BatchRegistrationDto.SourceTemplateId));
//                                            var template = SourceTemplates.FirstOrDefault(t => t.Id == templateId);
                                        }

                                        <DxComboBox Data="@SourceTemplates"
                                                    NullText="@PacsMessagesTranslations.SelectTemplate"
                                                    @bind-SelectedItem=@EditContext.SourceTemplate>
                                        </DxComboBox>

                                 
                                    </Template>
                                </DxFormLayoutItem>
                            </DxFormLayout>
                        </EditForm>
                    </EditFormTemplate>
                </DxDataGrid>

            </Template>
        </DxFormLayoutItem>
    </DxFormLayout>
}