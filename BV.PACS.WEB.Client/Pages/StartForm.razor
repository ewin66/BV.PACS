@inject HttpClient Http
@inject LookupService ApiService
@using System.Collections
@using BV.PACS.WEB.Client.Services.Api
@using BV.PACS.WEB.Shared.Models
@using BV.PACS.WEB.Shared.Models.Parameters
@using BV.PACS.WEB.Shared.Utils
@inherits BV.PACS.WEB.Client.Shared.Base.TranslatablePanel<BV.PACS.WEB.Client.I18nText.StartForm>
<h1>@Translations.Caption</h1>

<div class="row alert alert-primary background-white">
    <div class="col-sm-12">

        <span class="oi oi-pencil mr-2" aria-hidden="true"></span>

        @if (SourceTypes != null)
        {
            <DxTreeView AllowSelectNodes="true" 
                        Data="@GetParentNodes()"
                        SelectionChanged="@SelectionChanged"
                        TextExpression=@(dataItem => GetNodeText(dataItem))
                        ChildrenExpression=@(dataItem => GetNodeChildren(dataItem))>
            </DxTreeView>
        }

    </div>
</div>

@functions
{
    protected SourceMaterialTypeLookupItem[] SourceTypes { get; set; }

    IEnumerable GetParentNodes()
    {
        return SourceTypes.Where(s => s.ParentId.IsNullOrEmpty());
    }

    IEnumerable GetNodeChildren(object dataItem)
    {
        if (dataItem is SourceMaterialTypeLookupItem lookupItem)
        {
            return SourceTypes.Where(s => s.ParentId == lookupItem.Id);
        }


        return null;
    }

    string GetNodeText(object dataItem)
    {
        if (dataItem is SourceMaterialTypeLookupItem lookupItem)
        {
            return lookupItem.Name;
        }
        return "";
    }

    string SelectedGroup = "none";

    protected void SelectionChanged(TreeViewNodeEventArgs e)
    {
        SelectedGroup = e.NodeInfo.Text;
        StateHasChanged();
    }

    protected override async Task OnInitAsync()
    {
        await base.OnInitAsync();
        SourceTypes = await ApiService.GetSourceMaterialTypesLookup(Http, SourceMaterialTypeLookupParameter.Source);
    }

}