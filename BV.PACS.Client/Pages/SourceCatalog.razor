@page "/SourceCatalog"
@using BV.PACS.Shared.Models
@using Microsoft.AspNetCore.Components
@inject HttpClient Http

<h1>Source Catalog</h1>

<p>This component demonstrates fetching source data from the server.</p>


@if (_sources == null)
{
    <p>
        <em>Loading...</em>
    </p>
}
else
{
    <DxDataGrid Data=@_sources
                ShowFilterRow=@false
                ShowPager=@false
                PageSize=@_condition.PageSize>
        <DxDataGridCommandColumn Width="150px"></DxDataGridCommandColumn>
        <DxDataGridColumn Field=@nameof(SourceListItem.SourceBarcode)></DxDataGridColumn>
        <DxDataGridColumn Field=@nameof(SourceListItem.SourceTemplateName) Caption="Template Name"></DxDataGridColumn>
        <DxDataGridDateEditColumn Field=@nameof(SourceListItem.SourceCreationDate)></DxDataGridDateEditColumn>
        <DxDataGridColumn Field=@nameof(SourceListItem.SourceType)></DxDataGridColumn>
    </DxDataGrid>

    <DxPager PageCount=@_pageCount
             bind-ActivePageIndex=@ActivePageNumber
             CollapseButtonCount=@CollapseButtonCount>
    </DxPager>
}

@functions {
        const int CollapseButtonCount = 10;
    int _pageCount;

    readonly AggregatedConditionDto _condition = new AggregatedConditionDto();
    SourceListItem[] _sources;


    int ActivePageNumber
    {
        get => _condition.PageNumber;
        set
        {
            _condition.PageNumber = value;
            BeginGetSourcesAsync(_condition).ContinueWith(x => { StateHasChanged(); });
            StateHasChanged();
        }
    }

    protected override async Task OnInitAsync()
    {
        await BeginGetSourcesAsync(_condition);
        await BeginGetPageCountAsync(_condition);
    }

    private async Task BeginGetPageCountAsync(AggregatedConditionDto cond)
    {
        _pageCount = await Http.PostJsonAsync<int>("api/Catalog/GetSourcesRecordCount", cond) / cond.PageSize;
    }

    private async Task BeginGetSourcesAsync(AggregatedConditionDto cond)
    {
        _sources = await Http.PostJsonAsync<SourceListItem[]>("api/Catalog/GetSources", cond);
    }
}