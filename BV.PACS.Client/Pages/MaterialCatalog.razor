@page "/MaterialCatalog"
@using BV.PACS.Shared.Models
@using Microsoft.AspNetCore.Components
@inject HttpClient Http

<h1>Material Catalog</h1>

<p>This component demonstrates fetching Material data from the server.</p>


@if (_materials == null)
{
    <p>
        <em>Loading...</em>
    </p>
}
else
{
    <DxDataGrid Data=@_materials
                ShowFilterRow=@false
                ShowPager=@false
                PageSize=@_condition.PageSize>
        <DxDataGridCommandColumn Width="150px"></DxDataGridCommandColumn>
        <DxDataGridColumn Field=@nameof(MaterialListItem.MaterialBarcode)></DxDataGridColumn>
        <DxDataGridColumn Field=@nameof(MaterialListItem.MaterialTemplateName) Caption="Template Name"></DxDataGridColumn>
        <DxDataGridDateEditColumn Field=@nameof(MaterialListItem.MaterialRegistrationDate)></DxDataGridDateEditColumn>
        <DxDataGridColumn Field=@nameof(MaterialListItem.MaterialType)></DxDataGridColumn>
    </DxDataGrid>

    <DxPager PageCount=@_pageCount
             bind-ActivePageIndex=@ActivePageNumber
             CollapseButtonCount=@CollapseButtonCount>
    </DxPager>
}

@functions {
        const int CollapseButtonCount = 10;
    int _pageCount;

    readonly AggregatedConditionDto _condition = new AggregatedConditionDto();
    MaterialListItem[] _materials;


    int ActivePageNumber
    {
        get => _condition.PageNumber;
        set
        {
            _condition.PageNumber = value;
            BeginGetMaterialsAsync(_condition).ContinueWith(x => { StateHasChanged(); });
            StateHasChanged();
        }
    }

    protected override async Task OnInitAsync()
    {
        await BeginGetMaterialsAsync(_condition);
        await BeginGetPageCountAsync(_condition);
    }

    private async Task BeginGetPageCountAsync(AggregatedConditionDto cond)
    {
        _pageCount = await Http.PostJsonAsync<int>("api/Catalog/GetMaterialsRecordCount", cond) / cond.PageSize;
    }

    private async Task BeginGetMaterialsAsync(AggregatedConditionDto cond)
    {
        _materials = await Http.PostJsonAsync<MaterialListItem[]>("api/Catalog/GetMaterials", cond);
    }
}